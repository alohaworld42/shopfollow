# CartConnect GitLab CI/CD Pipeline
# Deploys frontend, Supabase migrations, and edge functions

stages:
  - test
  - build
  - deploy-db
  - deploy-functions
  - deploy-app

variables:
  NODE_VERSION: "20"
  DOCKER_TLS_CERTDIR: "/certs"

# ===========================================
# CACHE & DEFAULTS
# ===========================================

default:
  image: node:20-alpine
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/

.docker_base:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind

# ===========================================
# TEST STAGE
# ===========================================

lint:
  stage: test
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run lint || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

typecheck:
  stage: test
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===========================================
# BUILD STAGE
# ===========================================

build-docker:
  extends: .docker_base
  stage: build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build 
        --build-arg VITE_SUPABASE_URL=$SUPABASE_URL
        --build-arg VITE_SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
        -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
        -t $CI_REGISTRY_IMAGE:latest
        .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===========================================
# DATABASE MIGRATIONS
# ===========================================

deploy-migrations:
  stage: deploy-db
  image: supabase/cli:1.145.4
  script:
    - echo "Linking to Supabase project..."
    - supabase link --project-ref $SUPABASE_PROJECT_REF
    - echo "Pushing database migrations..."
    - supabase db push
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - supabase/migrations/**/*
  variables:
    SUPABASE_ACCESS_TOKEN: $SUPABASE_ACCESS_TOKEN
    SUPABASE_DB_PASSWORD: $SUPABASE_DB_PASSWORD

# ===========================================
# EDGE FUNCTIONS
# ===========================================

deploy-functions:
  stage: deploy-functions
  image: supabase/cli:1.145.4
  script:
    - supabase link --project-ref $SUPABASE_PROJECT_REF
    - echo "Deploying Edge Functions..."
    - supabase functions deploy webhook-shopify --no-verify-jwt
    - supabase functions deploy webhook-woocommerce --no-verify-jwt
    - supabase functions deploy webhook-generic --no-verify-jwt
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - supabase/functions/**/*
  variables:
    SUPABASE_ACCESS_TOKEN: $SUPABASE_ACCESS_TOKEN

# ===========================================
# DEPLOY TO GITLAB PAGES
# ===========================================

pages:
  stage: deploy-app
  dependencies:
    - typecheck
  script:
    - mv dist public
  artifacts:
    paths:
      - public
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===========================================
# DEPLOY TO KUBERNETES (Optional)
# ===========================================

.deploy-k8s:
  extends: .docker_base
  stage: deploy-app
  script:
    - apk add --no-cache kubectl
    - kubectl config set-cluster k8s --server=$K8S_SERVER --certificate-authority=$K8S_CA
    - kubectl config set-credentials gitlab --token=$K8S_TOKEN
    - kubectl config set-context default --cluster=k8s --user=gitlab
    - kubectl config use-context default
    - kubectl set image deployment/cartconnect cartconnect=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -n cartconnect
  environment:
    name: production
    kubernetes:
      namespace: cartconnect
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
